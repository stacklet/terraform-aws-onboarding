version: 3
automerge: true
delete_source_branch_on_merge: true
parallel_plan: true
parallel_apply: true

projects:
  - name: dev
    workflow: dev
    terraform_version: v1.11.3
    dir: .
    autoplan:
      when_modified:
        - "*.tf*"
        - "*/*tf."
        - "*/.terraform.lock.hcl"
        - "atlantis/dev/**"
    apply_requirements:
      - approved
      - mergeable
  - name: access
    dir: access
    workflow: dev
    terraform_version: v1.11.3
    autoplan:
      when_modified:
        - "*.tf*"
        - .terraform.lock.hcl
        - ../atlantis/dev/access/**
    apply_requirements:
      - approved
      - mergeable
  - name: org-read
    dir: org-read
    workflow: dev
    terraform_version: v1.11.3
    autoplan:
      when_modified:
        - "*.tf*"
        - .terraform.lock.hcl
        - ../atlantis/dev/org-read/**
    apply_requirements:
      - approved
      - mergeable

workflows:
  dev:
    plan:
      steps:
        - env:
            name: AWS_PROFILE
            value: Dev
        - env:
            name: AWS_DEFAULT_REGION
            value: us-east-2
        - env:
            name: AWS_REGION
            value: us-east-2
        - env:  # to avoid "text file busy" error when downloading providers
            name: TF_PLUGIN_CACHE_MAY_BREAK_DEPENDENCY_LOCK_FILE
            value: "true"
        - run: |
            if [ "$PROJECT_NAME" == dev ]; then
              cp atlantis/dev/main.tf .
            else
              cp -a ../atlantis/dev/${PROJECT_NAME}/* .
            fi
        - init
        - plan

    apply:
      steps:
        - env:
            name: AWS_PROFILE
            value: Dev
        - env:
            name: AWS_DEFAULT_REGION
            value: us-east-2
        - env:
            name: AWS_REGION
            value: us-east-2
        - env:  # to avoid "text file busy" error when downloading providers
            name: TF_PLUGIN_CACHE_MAY_BREAK_DEPENDENCY_LOCK_FILE
            value: "true"
        - run: |
            if [ "$PROJECT_NAME" == dev ]; then
              cp atlantis/dev/main.tf .
            else
              cp -a ../atlantis/dev/${PROJECT_NAME}/* .
            fi
        - apply
